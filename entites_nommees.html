#CACHE{0}

<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	#INSERT_HEAD
	<style>
		h1 {
			margin:0;
		}
		h2{
		}
		ul {
			margin:0;
			list-style-type:none;
			padding:0;
		}
		.col{
			float:left;
			width:12%;
			margin-left:30px;
		}
		.col ul {
			max-height:500px;
			overflow:auto;
		}
		.amis{
			margin:30px 0 ;
		}
	</style>
</head>
<body>

<div style="float:right;width:15%">
<INCLURE{fond=noms_navigation}>
</div>

<h1><a href="?page=entites_nommees">Entités nommées</a> <small style="font-size:0.5em">dans #NOM_SITE_SPIP</small></h1>

	<span></span>
	<h2>[(#GET{affdate}|trim|sinon{#ENV{sdate}})]</h2>


[(#REM) Débug ]
#SET{entites,#ARRAY}
<B_art>
<div id="debug" style="float:left;width:80%; max-height:300px;overflow:auto">
<BOUCLE_art(ARTICLES){id_article}{statut IN prop, publie}{si #VAL{1}|=={1}}>
	#SET{texte,#CHAPO*|concat{#TEXTE*}|preparer_texte}
	#SET{entites,#GET{entites}|array_merge{#GET{texte}|trouver_entites{#ID_ARTICLE}}}
</BOUCLE_art>
[<pre>(#GET{entites}|print_r{1})</pre>]
</div>
</B_art>

#SET{articles,#ARRAY}
#SET{compagnons,#ARRAY}
#SET{proches,#ARRAY}

#SET{filtre_entites,INDETERMINE}
[(#ENV{entite}|oui) #SET{filtre_entites,^#ENV{entite}} ]

#SET{andwhere,""}
[(#ENV{entite}|oui) #SET{andwhere,#VAL{"and entite regexp '^LENTITE'"}|replace{LENTITE,#ENV{entite}}} ]
[(#ENV{sdate}|oui) #SET{andwhere,#GET{andwhere}|concat{and date like}|concat{#ENV{sdate}|concat{%}|_q}} ]
[(#ENV{id_article}|oui) #SET{andwhere,#VAL{"and id_article=LID"}|replace{LID,#ENV{id_article}}} ]

	#SET{tab,#ARRAY}
	<BOUCLE_home(DATA){source sql, #VAL{"select entite, count(entite) nb from entites_nommees where type_entite in('Personnalités', 'Institutions', 'Institutions automatiques', 'Partis politiques', 'Peuples', 'a ajouter') group by entite having nb > 10 order by nb desc limit 0,50"}}{si #ENV{entite}|non}>
		#SET{tab,#GET{tab}|array_merge{#ARRAY{#ENTITE,#NB}}}
	</BOUCLE_home>

	#SET{pays,#ARRAY}
	<BOUCLE_territoires(DATA){source sql, #VAL{"select entite, count(entite) nb from entites_nommees where type_entite in('Pays', 'Geographie', 'Géographie (auto)', 'Villes') group by entite having nb > 10 order by nb desc limit 0,50"}}{si #ENV{entite}|non}>
		#SET{pays,#GET{pays}|array_merge{#ARRAY{#ENTITE,#NB}}}
	</BOUCLE_territoires>


	<B_top_entites>
	<div style="margin:40px 60px;padding:0 50px;line-height:1.8em;width:70%;text-align:center;">

	<BOUCLE_top_entites(DATA){source table, #GET{tab}}{par cle}>
	<span style="font-size:[(#VALEUR|nuage_mot{#GET{tab}|max})]em;">
		<a style="padding-right:20px;color:#000000;text-decoration:none" href="?page=entites_nommees[&amp;entite=(#CLE|rawurlencode)][&amp;sdate=(#ENV{sdate})][&amp;nb_articles=(#ENV{nb_articles})][&amp;id_article=(#ENV{id_article})]" title="[(#VALEUR)]&nbsp;fois">
[(#CLE|match{'\(.*\)'}|oui)[(#CLE|replace{" ",&nbsp;}|match{'\(.*\)'}|replace{'\(|\)',''})]]
		[(#CLE|match{'\(.*\)'}|non)[(#CLE|replace{" ",&nbsp;})]]
		</a>
	</span>
	</BOUCLE_top_entites>

	<br />
	<br />
	<br />

	<BOUCLE_top_territoires(DATA){source table, #GET{pays}}{par cle}>
	<span style="font-size:[(#VALEUR|nuage_mot{#GET{pays}|max})]em;">
		<a style="padding-right:20px;color:#000000;text-decoration:none" href="?page=entites_nommees[&amp;entite=(#CLE|rawurlencode)][&amp;sdate=(#ENV{sdate})][&amp;nb_articles=(#ENV{nb_articles})][&amp;id_article=(#ENV{id_article})]" title="[(#VALEUR)]&nbsp;fois">
[(#CLE|match{'\(.*\)'}|oui)[(#CLE|replace{" ",&nbsp;}|match{'\(.*\)'}|replace{'\(|\)',''})]]
		[(#CLE|match{'\(.*\)'}|non)[(#CLE|replace{" ",&nbsp;})]]
		</a>
	</span>
	</BOUCLE_top_territoires>


	</div>
	</B_top_entites>


	<B_type>
	<h2>
	<BOUCLE_type(DATA){source sql, #VAL{"select type_entite from entites_nommees where entite='LENTITE' limit 0,1"}|replace{LENTITE,#ENV{entite}}}{si #ENV{entite}|oui}>
	#TYPE_ENTITE
	</BOUCLE_type>
	</h2>
	</B_type>
	
	[<h3>(#ENV{entite}) </h3>]
	
	<BOUCLE_fc(DATA){source sql, #VAL{"select id_article from entites_nommees where entite='LENTITE' order by date desc"}|replace{LENTITE,#ENV{entite}} }{si #ENV{entite}|oui}> 			#SET{articles,#GET{articles}|push{#ID_ARTICLE}}</BOUCLE_fc>
	[(#GET{articles}|sizeof|>={1}|oui)#SET{andwhere,#VAL{"and id_article in (LESARTICLES)"}|replace{LESARTICLES,#GET{articles}|join{","}}}]
	
	<BOUCLE_fcl(DATA){source sql, #VAL{"select entite , count(entite) nb from entites_nommees where id_article in (LESARTICLES) and type_entite='Personnalités' group by entite having nb > 5 order by nb desc limit 0,10"}|replace{LESARTICLES,#GET{articles}|join{","}} }{si #GET{articles}|sizeof|>={1}|oui}>
	#SET{compagnons,#GET{compagnons}|array_merge{#ARRAY{#ENTITE,#NB}}}</BOUCLE_fcl>

	<B_cd>
	<div class="amis">
		<strong>Fidèles compagnons :</strong> <BOUCLE_cd(DATA){source table, #GET{compagnons}}{", "}{cle!=#ENV{entite}}{si #ENV{entite}|oui}><a href="?page=entites_nommees&entite=[(#CLE|urlencode)]">[(#CLE)]</a>[&nbsp;((#VALEUR))]</BOUCLE_cd>
	</div>
	</B_cd>

	<B_fragments_article>
	<h3 style="clear:both">Article [(#ENV{id_article})] (#GRAND_TOTAL) - <small><a href="?page=chercher_entites&id_article=#ENV{id_article}">re-indexer</a></small></h3>
	#ANCRE_PAGINATION
	<BOUCLE_fragments_article(DATA){source sql, #VAL{"select entite, extrait, id_article from entites_nommees where id_article='LENTITE' and type_entite='INDETERMINE' order by date desc"}|replace{LENTITE,#ENV{id_article}} }{!par valeur}{valeur > 1}{pagination 100}{si #ENV{id_article}|oui}>
		<div><strong>#ENTITE :</strong> [(#EXTRAIT)] 
		<small><a href="?page=entites_nommees&amp;id_article=[(#ID_ARTICLE)]">[voir]</a></small>
		</div>
	</BOUCLE_fragments_article>
	<p>#PAGINATION</p>
	</B_fragments_article>

	#SET{comp,'having nb > 5'}
	<BOUCLE_texte_article(ARTICLES){id_article}{statut IN prop, publie}>	
	#SET{comp,''}
	<h3 style="clear:both">#TITRE<small> — <a href="?page=entites_nommees&amp;sdate=[(#DATE_REDAC|annee)][-(#DATE_REDAC|mois)]">[(#DATE_REDAC|annee)][-(#DATE_REDAC|mois)]</a></small></h3>	
		
	<div class="texte">
		[(#CHAPO|concat{
			#TEXTE})]
		<div>
		#NOTES
		</div>
	</div>
	</BOUCLE_texte_article>

<div style="margin: 0 30px;">

	<div class="col">
	<B_personnalites_frequents>
		#ANCRE_PAGINATION
	
	 <h3>Personnalités</h3>
	
		<ul>
		<BOUCLE_personnalites_frequents(DATA){source sql, #VAL{"select entite , count(id_entite) nb from entites_nommees where type_entite='Personnalités' ANDWHERE group by entite COMP order by nb desc"}|replace{ANDWHERE,#GET{andwhere}}|replace{COMP,#GET{comp}}}{pagination 1000}>
			<li>#ENTITE&nbsp;<small><a href="?page=entites_nommees[&amp;entite=(#ENTITE|rawurlencode)][&amp;sdate=(#ENV{sdate})][&amp;nb_articles=(#ENV{nb_articles})][&amp;id_article=(#ENV{id_article})]">[(#NB)]&nbsp;fois</a>
		</small>
			</li>
		</BOUCLE_personnalites_frequents>
		</ul>
		<p>#PAGINATION</p>
	</B_personnalites_frequents>
	</div>
	
	[(#REM) afficher les entites suivantes en premier ]
	#SET{notin,#ARRAY}
	<BOUCLE_types(DATA){source sql, #VAL{"select type_entite from entites_nommees where type_entite in ('Institutions', 'Institutions automatiques', 'Partis politiques', 'a ajouter', 'Partis politiques', 'Sources') ANDWHERE group by type_entite"}|replace{ANDWHERE,#GET{andwhere}}}>
		#SET{notin,#GET{notin}|push{#TYPE_ENTITE|_q}}
		<div class="col" [ style="(#COMPTEUR_BOUCLE|alterner{'','','','',''})"]>
		<B_entite_frequents> 
		<h3>[(#TYPE_ENTITE|replace{_," "})]</h3>
			#ANCRE_PAGINATION
			<ul>
			<BOUCLE_entite_frequents(DATA){source sql, #VAL{"select entite , count(id_entite) nb from entites_nommees where type_entite='TYPEENTITE' ANDWHERE group by entite order by nb desc"}|replace{TYPEENTITE,#TYPE_ENTITE}|replace{ANDWHERE,#GET{andwhere}} }{pagination 1000}>
				<li>#ENTITE&nbsp;<small><a href="?page=entites_nommees[&amp;entite=(#ENTITE|rawurlencode)][&amp;sdate=(#ENV{sdate})][&amp;nb_articles=(#ENV{nb_articles})][&amp;id_article=(#ENV{id_article})]">[(#NB)]&nbsp;fois</a>
			</small>
				</li>
			</BOUCLE_entite_frequents>
			</ul>
			<p>#PAGINATION</p>
		</B_entite_frequents>
		</div>
	</BOUCLE_types>
	
	[(#SET{notin,#VAL{"and type_entite not in("}|concat{#GET{notin}|join{","}}|concat{")"}})]
	
	<BOUCLE_types_autres(DATA){source sql, #VAL{"select type_entite from entites_nommees where type_entite not in ('INDETERMINE', 'PASDENTITE', 'Personnalités') ANDWHERE NOTIN group by type_entite"}|replace{ANDWHERE,#GET{andwhere}}|replace{NOTIN,#GET{notin}}}>
		<div class="col" [ style="(#COMPTEUR_BOUCLE|alterner{'clear:both','','','','',''})"]>
		<B_entite_frequents_autres> 
		<h3>[(#TYPE_ENTITE|replace{_," "})]</h3>
			#ANCRE_PAGINATION
			<ul>
			<BOUCLE_entite_frequents_autres(DATA){source sql, #VAL{"select entite , count(id_entite) nb from entites_nommees where type_entite='TYPEENTITE' ANDWHERE group by entite order by nb desc"}|replace{TYPEENTITE,#TYPE_ENTITE}|replace{ANDWHERE,#GET{andwhere}} }{pagination 1000}>
				<li>#ENTITE&nbsp;<small><a href="?page=entites_nommees[&amp;entite=(#ENTITE|rawurlencode)][&amp;sdate=(#ENV{sdate})][&amp;nb_articles=(#ENV{nb_articles})][&amp;id_article=(#ENV{id_article})]">[(#NB)]&nbsp;fois</a>
			</small>
				</li>
			</BOUCLE_entite_frequents_autres>
			</ul>
			<p>#PAGINATION</p>
		</B_entite_frequents_autres>
		</div>
	</BOUCLE_types_autres>	

</div>

<hr style="clear:both" />


	<B_fragments_entite>
	#ANCRE_PAGINATION
	<BOUCLE_fragments_entite(DATA){source sql, #VAL{"select entite, extrait, id_article, type_entite from entites_nommees where entite='LENTITE' order by date desc"}|replace{LENTITE,#ENV{entite}} }{!par valeur}{valeur > 1}{pagination 500}{si #ENV{entite}|oui}>
		<div><BOUCLE_article(ARTICLES){id_article=#ID_ARTICLE}{statut IN prop, publie}><strong>[(#TITRE) ]</strong><small>[(#DATE_REDAC|nom_mois)][ (#DATE_REDAC|annee)]</small></BOUCLE_article> : [(#EXTRAIT)] 
		<small><a href="?page=entites_nommees&amp;id_article=[(#ID_ARTICLE)]">[voir]</a></small>
		</div>
	</BOUCLE_fragments_entite>
	<p>#PAGINATION</p>
	</B_fragments_entite>



<div id="debug" style="float:left;width:80%; max-height:300px;overflow:auto">


	<B_fragments>
	<h3>Entités résiduelles (#GRAND_TOTAL)</h3>
	#ANCRE_PAGINATION
	<BOUCLE_fragments(DATA){source sql, #VAL{"select count(id_entite) nb, entite, type_entite, extrait, id_article from entites_nommees where type_entite='INDETERMINE' ANDWHERE group by entite order by nb desc"}|replace{ANDWHERE,#GET{andwhere}} }{!par valeur}{valeur > 1}{pagination 100}{si #ENV{id_article}|non}>
		<div><strong>#ENTITE <small>(#TYPE_ENTITE)</small> :</strong> <small><a href="?page=entites_nommees[&amp;entite=(#ENTITE|rawurlencode)][&amp;sdate=(#ENV{sdate})][&amp;nb_articles=(#ENV{nb_articles})]">[(#NB)]&nbsp;fois</a></small> [(#EXTRAIT)] 
		<small><a href="?page=entites_nommees&amp;id_article=[(#ID_ARTICLE)]">[voir]</a></small>
		</div>
	</BOUCLE_fragments>
	<p>#PAGINATION</p>
	</B_fragments>	

</div>

<div style="clear:left"></div>

</body>
</html>