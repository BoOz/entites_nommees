#SET{articles,#ARRAY}
#SET{compagnons,#ARRAY}
#SET{proches,#ARRAY}

#SET{filtre_entites,INDETERMINE}
[(#ENV{entite}|oui) #SET{filtre_entites,^#ENV{entite}} ]

#SET{andwhere,""}

<style>
	ul {
		margin:0;
		list-style-type:none;
		padding:0;
	}
	.col{
		width:138px;
		margin-right:32px;
		margin-bottom:60px;
	}
	.col ul {
		max-height:500px;
		overflow:auto;
	}
	.amis{
		margin:30px 0 ;
	}
	.a_ajouter {
		background-color: #2c3f4f;
		color: #bbbbbb;
		margin: 0;
		padding: 40px ;
	}
	.a_ajouter a{
		color : white ;
	}
	.entites_residuelles {
		margin: 0;
		padding-top: 40px ;
	}
	.entites_residuelles a{
	}
	.ariane a {
		text-decoration:none;
	}
	
</style>

<div class="categorie hermetique"><B_type>
	<BOUCLE_type(DATA){source sql, #VAL{"select type_entite from entites_nommees where entite=LENTITE limit 0,1"}|replace{LENTITE,#ENV{entite}|_q}}{si #ENV{entite}|oui}>
		<p>Type : #TYPE_ENTITE</p>
	</BOUCLE_type>
	
	<BOUCLE_articles_lies(DATA){source sql, #VAL{"select id_article from entites_nommees where entite=LENTITE order by date desc"}|replace{LENTITE,#ENV{entite}|_q} }{si #ENV{entite}|oui}> #SET{articles,#GET{articles}|push{#ID_ARTICLE}}</BOUCLE_articles_lies>
	
	[(#REM) Poids total des références les plus fréquentes (ne pas en prendre plus de 5 000 sinon c long ? ) ]
	#SET{references,#ARRAY}
	<BOUCLE_references_global(DATA){source file,#CHEMIN{'stats/decompte_references.txt'}}{si #CHEMIN{'stats/decompte_references.txt'}}{0,5000}> #SET{entite,#VALEUR|explode{"	"}|table_valeur{0}} #SET{poids,#VALEUR|explode{"	"}|table_valeur{2}} #SET{references,#GET{references}|array_merge{#ARRAY{#GET{entite},#GET{poids}}}} </BOUCLE_references_global>
	
	[(#REM) références proches ]
	
	[(#REM) tous les articles avec cette entité ]
	#SET{andwhere,#VAL{"and id_article in (LESARTICLES) and entite !=LENTITE"}|replace{LENTITE,#ENV{entite}|_q}|replace{LESARTICLES,#GET{articles}|join{","}}}
	
	[(#REM) Entités les plus fréquentes dans ces articles pondéré par poids total ]
	#SET{refs,#ARRAY}
	<BOUCLE_refs(DATA){source sql, #VAL{"select entite, count(entite) nb from entites_nommees where 1 ANDWHERE and type_entite not in('Lieux de publication') group by entite order by nb desc limit 0,100"}|replace{ANDWHERE,#GET{andwhere}}}{si #ENV{id_article}|non}> #SET{refs,#GET{refs}|array_merge{#ARRAY{#ENTITE,#NB|div{#GET{references}|table_valeur{#ENTITE}|sinon{5000}}}}}</BOUCLE_refs>
	
	[(#REM) Pondération par le poids de chaque ]
	
<B_references_proches>
		Relations : 
	<div style="margin:0px 60px 20px 0px;padding:0 50px;line-height:1.8em;text-align:center;">
	
	<BOUCLE_references_proches(DATA){source table,#GET{refs}}{par cle}{0,50}{valeur > 0.02}{si #ENV{entite}}>
				<span style="font-size:[(#VALEUR|nuage_mot{#GET{refs}|max})]em;">
					<a style="padding-right:20px;text-decoration:none" href="#URL_PAGE{entite,entite=#CLE}" title="[(#CLE|match{'\(.*\)'}|oui) #CLE , ]score : #VALEUR">
						[(#CLE|match{'\(.*\)'}|oui)[(#CLE|replace{" ",&nbsp;}|match{'\(.*\)'}|replace{'\(|\)',''}|replace{^.*:})]]
						[(#CLE|match{'\(.*\)'}|non)[(#CLE|replace{" ",&nbsp;}|replace{^.*:})]]
					</a>
				</span>
	</BOUCLE_references_proches>
	</div>
</B_references_proches>

</div>

<INCLURE{fond=inclure/entite_temps,entite}>

[(#ENV{entite}|oui) #SET{andwhere,#VAL{" and entite = LENTITE "}|replace{LENTITE,#VAL{""}|concat{#ENV{entite}}|concat{""}|_q}|replace{"^'"}|replace{"'$"}} ]
[(#ENV{sdate}|oui) #SET{andwhere,#GET{andwhere}|concat{ and date like }|concat{#ENV{sdate}|concat{%}|_q}} ]
[(#ENV{id_article}|oui) #SET{andwhere,#VAL{" and id_article=LID "}|replace{LID,#ENV{id_article}}} ]

#SET{req,#VAL{"select entite, extrait, id_article, type_entite, date from entites_nommees where 1 ANDWHERE order by date desc"}|replace{ANDWHERE,#GET{andwhere}}}
<B_extraits_articles_entite>
	<h2 class="catego">Nos articles <span>(#GRAND_TOTAL documents)</span></h2>
	<div style="max-height:200px;overflow:auto;clear:left; margin: 30px 0;">
	#ANCRE_PAGINATION
	<BOUCLE_extraits_articles_entite(DATA){source sql,#GET{req}}{pagination 50}{si #ENV{entite}|oui}>
		<p>
			<BOUCLE_article(ARTICLES){id_article=#ID_ARTICLE}{statut IN prop, publie}>
			<strong>#TITRE</strong><small>, [(#DATE_REDAC|nom_mois)][ (#DATE_REDAC|annee)]</small></BOUCLE_article>
			<div class="intro">
			(...)[ (#EXTRAIT) ](...) <a href="./?page=article&id_article=#ID_ARTICLE#references" title="Extrait de « [(#TITRE)] »">[voir]</a>
			</div>
		</p>
	</BOUCLE_extraits_articles_entite>
		<p>#PAGINATION</p>
	</div>
</B_extraits_articles_entite>

<h2 class="catego">Principales références [ (#ENV{entite}|oui)proches de [(#ENV{entite})]]</h2>

<div id="nuage_entites" style="margin-bottom:30px">
	<INCLURE{fond=inclure/entites,entite}>
</div>


<BOUCLE_rem(DATA){liste 1}{si #GET{rem}|non}>

<h2 class="catego">Toutes les références [ (#ENV{entite}|oui)proches de [(#ENV{entite})]]</h2>


#SET{comp,'having nb > 5'}

#SET{andwhere,""}
[(#ENV{sdate}|oui) #SET{andwhere,#GET{andwhere}|concat{ and date like }|concat{#ENV{sdate}|concat{%}|_q}} ]
[(#ENV{id_article}|oui) #SET{andwhere,#VAL{" and id_article=LID "}|replace{LID,#ENV{id_article}}} ]
[(#GET{articles}|sizeof|>={1}|oui)
#SET{andwhere,#GET{andwhere}|concat{" and id_article in (LESARTICLES) and entite !=LENTITE"}|replace{LENTITE,#ENV{entite}|_q}|replace{LESARTICLES,#GET{articles}|join{","}}}
]

#SET{req,#VAL{"select entite , count(id_entite) nb from entites_nommees where type_entite='Personnalités' ANDWHERE group by entite COMP order by nb desc"}|replace{ANDWHERE,#GET{andwhere}}|replace{COMP,#GET{comp}}}

<div style="margin:0 40px 0 0;display: flex; flex-flow: row wrap;">

		<B_personnalites_frequents>
			#ANCRE_PAGINATION
		<div class="col">
			<h3>Personnalités</h3>
			<ul>
			<BOUCLE_personnalites_frequents(DATA){source sql, #VAL{"select entite , count(id_entite) nb from entites_nommees where type_entite='Personnalités' ANDWHERE group by entite COMP order by nb desc"}|replace{ANDWHERE,#GET{andwhere}}|replace{COMP,#GET{comp}}}{pagination 1000}>
				<li>#ENTITE&nbsp;<small><a href="?page=entite[&amp;entite=(#ENTITE|rawurlencode)][&amp;sdate=(#ENV{sdate})][&amp;nb_articles=(#ENV{nb_articles})][&amp;id_article=(#ENV{id_article})]">[(#NB)]&nbsp;fois</a>
			</small>
				</li>
			</BOUCLE_personnalites_frequents>
			</ul>
			<p>#PAGINATION</p>
		</div>
		</B_personnalites_frequents>

		
		#SET{notin,#ARRAY}
		
		[(#REM).Rassembler les institutions ]
		
		<B_institutions_frequents> 
		<div class="col">
			<h3>Institutions</h3>
				#ANCRE_PAGINATION
				<ul>
				<BOUCLE_institutions_frequents(DATA){source sql, #VAL{"select type_entite, entite , count(id_entite) nb from entites_nommees where type_entite in ('Institutions', 'Institutions automatiques') ANDWHERE group by entite order by nb desc"}|replace{TYPEENTITE,#TYPE_ENTITE}|replace{ANDWHERE,#GET{andwhere}} }{pagination 1000}>
					<li>#ENTITE&nbsp;<small><a href="?page=entite[&amp;entite=(#ENTITE|rawurlencode)][&amp;sdate=(#ENV{sdate})][&amp;nb_articles=(#ENV{nb_articles})][&amp;id_article=(#ENV{id_article})]">[(#NB)]&nbsp;fois</a>[(#TYPE_ENTITE|match{auto}|oui) (auto) ]
				</small>
					</li>
				</BOUCLE_institutions_frequents>
				</ul>
				<p>#PAGINATION</p>
			</div>
		</B_institutions_frequents>
		
		<B_lieux_frequents> 
		<div class="col">
			<h3>Lieux</h3>
				#ANCRE_PAGINATION
				<ul>
				<BOUCLE_lieux_frequents(DATA){source sql, #VAL{"select type_entite, entite , count(id_entite) nb from entites_nommees where type_entite in ('Pays', 'Geographie', 'Geographie', 'Géographie (auto)', 'Villes') ANDWHERE group by entite order by nb desc"}|replace{TYPEENTITE,#TYPE_ENTITE}|replace{ANDWHERE,#GET{andwhere}} }{pagination 1000}>
					#SET{notin,#GET{notin}|push{#TYPE_ENTITE|_q}}
					<li>#ENTITE&nbsp;<small><a href="?page=entite[&amp;entite=(#ENTITE|rawurlencode)][&amp;sdate=(#ENV{sdate})][&amp;nb_articles=(#ENV{nb_articles})][&amp;id_article=(#ENV{id_article})]">[(#NB)]&nbsp;fois</a>[(#TYPE_ENTITE|match{auto}|oui) (auto) ]
				</small>
					</li>
				</BOUCLE_lieux_frequents>
				</ul>
				<p>#PAGINATION</p>
			</div>
		</B_lieux_frequents>
		
		[(#REM) afficher les entites suivantes en premier ]
		<BOUCLE_types(DATA){source sql, #VAL{"select type_entite from entites_nommees where type_entite in ('Partis politiques', 'Sujets') ANDWHERE group by type_entite order by type_entite desc"}|replace{ANDWHERE,#GET{andwhere}}}>
			#SET{notin,#GET{notin}|push{#TYPE_ENTITE|_q}}
			<div class="col" [ style="(#COMPTEUR_BOUCLE|alterner{'','','','',''})"]>
			<B_entite_frequents> 
			<h3>[(#TYPE_ENTITE|replace{_," "})]</h3>
				#ANCRE_PAGINATION
				<ul>
				<BOUCLE_entite_frequents(DATA){source sql, #VAL{"select entite , count(id_entite) nb from entites_nommees where type_entite='TYPEENTITE' ANDWHERE group by entite order by nb desc"}|replace{TYPEENTITE,#TYPE_ENTITE}|replace{ANDWHERE,#GET{andwhere}} }{pagination 1000}>
					<li>#ENTITE&nbsp;<small><a href="?page=entite[&amp;entite=(#ENTITE|rawurlencode)][&amp;sdate=(#ENV{sdate})][&amp;nb_articles=(#ENV{nb_articles})][&amp;id_article=(#ENV{id_article})]">[(#NB)]&nbsp;fois</a>
				</small>
					</li>
				</BOUCLE_entite_frequents>
				</ul>
				<p>#PAGINATION</p>
			</B_entite_frequents>
			</div>
		</BOUCLE_types>
		[(#SET{notin,#VAL{"and type_entite not in("}|concat{#GET{notin}|join{","}}|concat{")"}})]
		
		
		<BOUCLE_types_autres(DATA){source sql, #VAL{"select type_entite from entites_nommees where type_entite not in ('INDETERMINE', 'PASDENTITE', 'Personnalités','a ajouter', 'Institutions', 'Institutions automatiques') ANDWHERE NOTIN group by type_entite"}|replace{ANDWHERE,#GET{andwhere}}|replace{NOTIN,#GET{notin}}}>
			<div class="col" [ style="(#COMPTEUR_BOUCLE|alterner{'clear:both','','','','',''})"]>
			<B_entite_frequents_autres> 
			<h3>[(#TYPE_ENTITE|replace{_," "})]</h3>
				#ANCRE_PAGINATION
				<ul>
				<BOUCLE_entite_frequents_autres(DATA){source sql, #VAL{"select entite , count(id_entite) nb from entites_nommees where type_entite='TYPEENTITE' ANDWHERE group by entite order by nb desc"}|replace{TYPEENTITE,#TYPE_ENTITE}|replace{ANDWHERE,#GET{andwhere}} }{pagination 1000}>
					<li>[(#ENTITE|replace{^.*:})]&nbsp;<small><a href="?page=entite[&amp;entite=(#ENTITE|rawurlencode)][&amp;sdate=(#ENV{sdate})][&amp;nb_articles=(#ENV{nb_articles})][&amp;id_article=(#ENV{id_article})]">[(#NB)]&nbsp;fois</a>
				</small>
					</li>
				</BOUCLE_entite_frequents_autres>
				</ul>
				<p>#PAGINATION</p>
			</B_entite_frequents_autres>
			</div>
		</BOUCLE_types_autres>

</div>

<div class="a_ajouter" style="clear:both;line-height:1.3em">
	<B_a_ajouter>
		#ANCRE_PAGINATION
	 <h3>À ajouter</h3>
		<ul>
		<BOUCLE_a_ajouter(DATA){source sql, #VAL{"select entite , count(id_entite) nb from entites_nommees where type_entite='a ajouter' ANDWHERE group by entite order by nb desc"}|replace{ANDWHERE,#GET{andwhere}}|replace{COMP,#GET{comp}}}{pagination 1000}>
			<li style="float:left;padding-right:15px">
			#ENTITE&nbsp;<small><a href="?page=entite[&amp;entite=(#ENTITE|rawurlencode)][&amp;sdate=(#ENV{sdate})][&amp;nb_articles=(#ENV{nb_articles})][&amp;id_article=(#ENV{id_article})]">[(#NB)]&nbsp;fois</a>
		</small>
			</li>
		</BOUCLE_a_ajouter>
		</ul>
		<p>#PAGINATION</p>
	</B_a_ajouter>
	<br style="clear:both" />
</div>

<div class="entites_residuelles ui segment left aligned container">
	<B_fragments>
	<h2 class="catego" title="Références inconnues[ (#ENV{entite}|oui)proches de [(#ENV{entite})]]">Références inconnues <span>(#GRAND_TOTAL)</span></h2>
	<p>Notre algorithme a extrait ces références en raison de leurs lettres capitales, mais il ne les a pas reconnues.</p>
	#ANCRE_PAGINATION
	<BOUCLE_fragments(DATA){source sql, #VAL{"select count(id_entite) nb, entite, type_entite, extrait, id_article from entites_nommees where type_entite='INDETERMINE' ANDWHERE group by entite order by nb desc"}|replace{ANDWHERE,#GET{andwhere}} }{!par valeur}{valeur > 1}{pagination 100}{si #ENV{id_article}|non}>
		<div><strong><a href="?page=entite[&amp;entite=(#ENTITE|rawurlencode)][&amp;sdate=(#ENV{sdate})][&amp;nb_articles=(#ENV{nb_articles})]">[(#ENTITE)]</a> :</strong> <small>[(#NB)]&nbsp;fois</small> [(#EXTRAIT)] 
		<small><a href="?page=article&amp;id_article=[(#ID_ARTICLE)#references#references]">[voir]</a></small>
		</div>
	</BOUCLE_fragments>
	<p>#PAGINATION</p>
	</B_fragments>
</div>

</BOUCLE_rem>
